ymq_define("Upload",["jquery"],(function(t){return class e{constructor(){this.instance=null,this.init()}init(){this.disabledFileInput().initMemberVariables().initModal().initOptions().registerEvent(),this.registerFileInputChangeEvent()}initMemberVariables(){var t=this;return t.cropper=null,t.files=null,t.num=0,t.fileData={},t.rectangleRatios=[],t.formData=new FormData,t.inputDom=null,t.previewReady=!1,t.imgDom=null,t}disabledFileInput(){return t(document).on("click",".ymq_upload_new.ymq_disabled",(function(t){return t.stopImmediatePropagation(),t.preventDefault(),!1})),this}initOptions(){var e=this;return e.options={ready:function(){var i=this.cloneNode();i.className="",i.style.cssText="display: block;width: 100%;min-width: 0;min-height: 0;max-width: none;max-height: none;",t(".ymq-img-review")[0].appendChild(i.cloneNode()),e.previewReady=!0},dragMode:"move",isRound:!1,crop:function(i){if(e.previewReady){var a=i.detail,n=this.cropper.getImageData(),o=a.width/a.height,m=t(".ymq-img-review")[0];if(m){var d=m.getElementsByTagName("img").item(0),l=m.offsetWidth,s=l/o,r=a.width/l;m.style.height=s+"px",d&&(d.style.width=n.naturalWidth/r+"px",d.style.height=n.naturalHeight/r+"px",d.style.marginLeft=-a.x/r+"px",d.style.marginTop=-a.y/r+"px")}}}},e}resetAspectRatio(t){var e=this;return 2==(t=t.split(":")).length?(t=t[0]/t[1],e.options.aspectRatio=t):delete e.options.aspectRatio,e}registerEvent(){var e=this;return t(document).on("click",".ymq-cropper-button-resize",(function(){e.destroyCropper().resetAspectRatio(t(this).data("aspect-ratio")).newCropper()})),e.modal.find("#ymq-do-cropper").on("click",(function(){if(e.cropper){e.getCanvas().toDataURL("image/jpeg",1);e.getCanvas().toBlob((function(t){e.addImg(t)}))}})),e}destroyCropper(){var t=this;return t.cropper.destroy(),t.cropper=null,t}newCropper(){var t=this;return t.cropper=new Cropper(t.imgDom[0],t.options),t.modal.resize(),t}initRectangleRatio(){var e=this;e.rectangleRatios=[],e.resetAspectRatio("");var i=e.inputDom.data("rectangle-ratio");i&&(i=i.split(",")).length>0&&(e.rectangleRatios=i,e.resetAspectRatio(e.rectangleRatios[0])),e.options.isRound=!1,t(".ymq-img-container").removeClass("cropper-container-round"),2==e.inputDom.data("cropper")&&(e.resetAspectRatio("1:1"),t(".ymq-img-container").addClass("cropper-container-round"));var a="";return e.rectangleRatios.forEach((function(t){a+=`<div class="ymq-cropper-button ymq-cropper-button-resize" data-aspect-ratio="${t}">${t}</div>`})),e.modal.find(".ymq-img-action_m").html(a),e.modal.find(".ymq-img-action_pc").html(a),e}getCanvas(){var t=this;if(2==t.inputDom.data("cropper")){var e=t.cropper.getCroppedCanvas(),i=document.createElement("canvas"),a=i.getContext("2d"),n=e.width,o=e.height;return i.width=n,i.height=o,a.imageSmoothingEnabled=!0,a.drawImage(e,0,0,n,o),a.globalCompositeOperation="destination-in",a.beginPath(),a.arc(n/2,o/2,Math.min(n,o)/2,0,2*Math.PI,!0),a.fill(),i}return t.cropper.getCroppedCanvas()}registerFileInputChangeEvent(){var e=this;return t(document).on("change",'form[action="/cart/add"] input[type="file"]',(function(i){e.inputDom=t(this),e.files=i.target.files,e.inputDom.val()&&(0!=e.inputDom.data("cropper")?e.initRectangleRatio().doCropper():e.addFile())})),e}doCropper(){var t,e,i=this;i.files&&i.files.length>0&&(t=i.files[0],/^image\/\w+/.test(t.type)?URL?i.done(URL.createObjectURL(t)):FileReader&&((e=new FileReader).onload=function(t){i.done(e.result)},e.readAsDataURL(t)):i.addFile())}done(t){var e=this;e.inputDom.val(""),e.imgDom.prop("src",t),e.modal.modal("show")}isDisabled(){var t=this,e=t.inputDom.prop("name"),i=t.inputDom.data("file-num"),a=0;t.fileData.hasOwnProperty(e)&&(a=Object.keys(t.fileData[e]).length),a>=i?t.inputDom.parents(".ymq_upload_new").addClass("ymq_disabled"):t.inputDom.parents(".ymq_upload_new").removeClass("ymq_disabled")}addFile(){var e=this,i="",a=e.inputDom.prop("name"),n=e.inputDom.parents(".ymq-options-box").find(".ymq_upload_img_view"),o=e.inputDom.parents(".ymq-options-box").find(".ymq_upload_file_view"),m=e.inputDom.data("file-num"),d=e.files.length,l="";e.fileData.hasOwnProperty(a)||(e.fileData[a]={}),(m-=Object.keys(e.fileData[a]).length)<=e.files.length&&(d=m);for(let m=0;m<d;m++)e.fileData[a][e.num]={file:e.files[m],name:e.files[m].name},/^image\/\w+/.test(e.files[m].type)?(URL&&(i=URL.createObjectURL(e.files[m])),l=`\n\t\t\t\t\t\t<div class="ymq_upload_img_item ymq_upload_file_item ymq_upload_file_item_${e.num}" style="display: none;" data-name="${a}" data-num="${e.num}">\n\t\t\t\t\t\t\t<img class="ymq_img_item" src="${i}" alt="">\n\t\t\t\t\t\t\t<div class="ymq_upload_img_item_bg">\n\t\t\t\t\t\t\t\t<span data-name="${a}" data-num="${e.num}" class="ymq_upload_img_item_del ymq_upload_file_item_del"></span>\n\t\t\t\t\t\t\t\t<div class="spotlight" data-src="${i}"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`,n.prepend(l),t(`.ymq_upload_file_item_${e.num}`).fadeIn()):(l=`\n\t\t\t\t\t\t<div class="ymq_upload_item ymq_upload_file_view ymq_upload_file_item ymq_upload_file_item_${e.num}">\n\t\t\t\t\t\t\t<div class="ymq_upload_type ymq_upload_img"></div>\n\t\t\t\t\t\t\t<div class="ymq_upload_name">${e.files[m].name}</div>\n\t\t\t\t\t\t\t<div data-name="${a}" data-num="${e.num}" class="ymq_upload_status ymq_upload_success ymq_upload_file_item_del"></div>\n\t\t\t\t\t\t\t<div class="ymq_clear_both"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`,o.append(l),t(`.ymq_upload_file_item_${e.num}`).fadeIn()),e.num++;e.inputDom.val("").change(),e.isDisabled()}addImg(e){var i=this,a=URL.createObjectURL(e),n=i.inputDom.parents(".ymq-options-box").find(".ymq_upload_img_view"),o=i.inputDom.prop("name"),m=`\n\t\t\t\t<div class="ymq_upload_img_item ymq_upload_file_item ymq_upload_file_item_${i.num}" style="display: none;" data-name="${o}" data-num="${i.num}">\n\t\t\t\t\t<img class="ymq_img_item" src="${a}" alt="">\n\t\t\t\t\t<div class="ymq_upload_img_item_bg">\n\t\t\t\t\t\t<span data-name="${o}" data-num="${i.num}" class="ymq_upload_img_item_del ymq_upload_file_item_del"></span>\n\t\t\t\t\t\t<div class="spotlight" data-src="${a}"></div>\n\t\t\t\t\t</div>\n\t\t\t  \t</div>\n\t\t\t`;i.fileData.hasOwnProperty(o)||(i.fileData[o]={}),i.fileData[o][i.num]={file:e,name:`${o}_${i.num}.jpg`},i.formData.append(o,e,`${o}.jpg`),n.prepend(m),t(`.ymq_upload_file_item_${i.num}`).fadeIn(),i.modal.modal("hide"),i.num++,i.inputDom.val("").change(),i.isDisabled()}initModal(){var e=this;return t("body").append('\n\t\t\t\t<div class="ymq-bmodal ymq-modal-fade" id="ymqBootModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">\n\t\t\t\t\t<div class="ymq-modal-dialog ymq-modal-lg" role="document">\n\t\t\t\t\t  <div class="ymq-bmodal-content">\n\t\t\t\t\t\t<div class="ymq-modal-header">\n\t\t\t\t\t\t  <div class="ymq-modal-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ymq-modal-body">\n\t\t\t\t\t\t  <div class="ymq-img-container">\n\t\t\t\t\t\t\t<div class="ymq-img-cropper-container">\n\t\t\t\t\t\t\t  <img id="ymq-upload-cropper-img" src="">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="ymq-img-review-container">\n\t\t\t\t\t\t\t  <div class="ymq-img-review">\n\t\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t\t  <div class="ymq-img-action ymq-img-action_m ymq_m_show">\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ymq-modal-footer">\n\t\t\t\t\t\t  <div class="ymq-cropper-button ymq-cropper-button-close" data-dismiss="modal">Close</div>\n\t\t\t\t\t\t  <div class="ymq-img-action ymq-img-action_pc ymq_pc_show">\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t  <div class="ymq-cropper-button" id="ymq-do-cropper">Save</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t  </div>\n\t\t\t\t\t</div>\n\t\t\t\t  </div>\n\t\t\t'),e.imgDom=t("#ymq-upload-cropper-img"),e.modal=t("#ymqBootModal"),e.modal.on("shown.bs.modal",(function(){e.newCropper()})).on("hidden.bs.modal",(function(){e.destroyCropper(),t(".ymq-img-review").html("")})),e}static getInstance(){return this.instance||(this.instance=new e),this.instance}}}));